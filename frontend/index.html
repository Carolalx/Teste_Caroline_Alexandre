<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <title>Operadoras de Saúde</title>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.7.14/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th,
        td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #f4f4f4;
        }

        input {
            padding: 6px;
            width: 300px;
            margin-top: 10px;
        }

        .loading {
            font-weight: bold;
            margin-top: 20px;
        }

        .pagination {
            margin-top: 10px;
        }

        .pagination button {
            margin-right: 5px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: #fff;
            padding: 20px;
            border-radius: 5px;
            width: 400px;
        }
    </style>
</head>

<body>
    <div id="app">
        <h1>Operadoras de Saúde</h1>

        <input type="text" v-model="busca" placeholder="Buscar por RegistroANS ou Razão Social" />

        <div v-if="loading" class="loading">Carregando dados...</div>

        <table v-if="!loading && operadoras.length">
            <thead>
                <tr>
                    <th>RegistroANS</th>
                    <th>Razão Social</th>
                    <th>UF</th>
                    <th>Valor Despesas</th>
                    <th>Detalhes</th>
                </tr>
            </thead>
            <tbody>
                <tr v-for="op in operadorasFiltradas" :key="op.RegistroANS">
                    <td>{{ op.RegistroANS }}</td>
                    <td>{{ op.RazaoSocial }}</td>
                    <td>{{ op.UF }}</td>
                    <td>{{ formatCurrency(op.TotalDespesas) }}</td>
                    <td><button @click="abrirDetalhes(op.RegistroANS)">Ver</button></td>
                </tr>
            </tbody>
        </table>

        <div v-if="!loading && !operadoras.length">Nenhum registro encontrado.</div>

        <div class="pagination" v-if="!loading && totalPages > 1">
            <button @click="mudarPagina(paginaAtual-1)" :disabled="paginaAtual === 1">Anterior</button>
            <span>Página {{ paginaAtual }} de {{ totalPages }}</span>
            <button @click="mudarPagina(paginaAtual+1)" :disabled="paginaAtual === totalPages">Próxima</button>
        </div>

        <h2>Distribuição de Despesas por UF</h2>
        <canvas id="graficoUF" width="400" height="200"></canvas>

        <!-- Modal detalhes -->
        <div class="modal" :style="{ display: modalAberto ? 'flex' : 'none' }">
            <div class="modal-content">
                <h3>Detalhes Operadora</h3>
                <div v-if="detalhes">
                    <p><strong>RegistroANS:</strong> {{ detalhes.RegistroANS }}</p>
                    <p><strong>Razão Social:</strong> {{ detalhes.RazaoSocial }}</p>
                    <p><strong>UF:</strong> {{ detalhes.UF }}</p>
                    <p><strong>Total Despesas:</strong> {{ formatCurrency(detalhes.TotalDespesas) }}</p>
                    <h4>Histórico de Despesas</h4>
                    <ul>
                        <li v-for="(d, index) in historico" :key="index">
                            Média Trimestral: {{ formatCurrency(d.MediaTrimestral) }}, Desvio: {{
                            formatCurrency(d.DesvioPadrao) }}
                        </li>
                    </ul>
                </div>
                <button @click="modalAberto = false">Fechar</button>
            </div>
        </div>
    </div>

    <script>
        new Vue({
            el: "#app",
            data: {
                operadoras: [],
                busca: "",
                loading: true,
                paginaAtual: 1,
                limite: 50,
                total: 0,
                modalAberto: false,
                detalhes: null,
                historico: [],
                grafico: null
            },
            computed: {
                totalPages() {
                    return Math.ceil(this.total / this.limite);
                },
                operadorasFiltradas() {
                    if (!this.busca) return this.operadoras;
                    return this.operadoras.filter(op =>
                        (op.RazaoSocial && op.RazaoSocial.toLowerCase().includes(this.busca.toLowerCase())) ||
                        (op.RegistroANS && op.RegistroANS.toString().includes(this.busca))
                    );
                }
            },
            methods: {
                carregarOperadoras() {
                    this.loading = true;
                    axios.get(`http://127.0.0.1:8000/api/operadoras?page=${this.paginaAtual}&limit=${this.limite}`)
                        .then(res => {
                            this.operadoras = res.data.data;
                            this.total = res.data.total;
                            this.loading = false;
                            this.criarGrafico();
                        })
                        .catch(err => {
                            console.error("Erro ao carregar operadoras:", err);
                            this.loading = false;
                        });
                },
                formatCurrency(valor) {
                    if (valor == null) return "R$ 0,00";
                    return Number(valor).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                },
                mudarPagina(n) {
                    if (n < 1 || n > this.totalPages) return;
                    this.paginaAtual = n;
                    this.carregarOperadoras();
                },
                criarGrafico() {
                    const ctx = document.getElementById('graficoUF').getContext('2d');
                    const ufMap = {};
                    this.operadoras.forEach(op => {
                        if (!op.UF) return;
                        if (!ufMap[op.UF]) ufMap[op.UF] = 0;
                        ufMap[op.UF] += Number(op.TotalDespesas) || 0;
                    });
                    if (this.grafico) this.grafico.destroy();
                    this.grafico = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: Object.keys(ufMap),
                            datasets: [{
                                label: 'Total de Despesas por UF',
                                data: Object.values(ufMap),
                                backgroundColor: 'rgba(54, 162, 235, 0.6)',
                                borderColor: 'rgba(54, 162, 235, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: { scales: { y: { beginAtZero: true } } }
                    });
                },
                abrirDetalhes(registro_ans) {
                    axios.get(`http://127.0.0.1:8000/api/operadoras/${registro_ans}`)
                        .then(res => {
                            this.detalhes = res.data;
                            return axios.get(`http://127.0.0.1:8000/api/operadoras/${registro_ans}/despesas`);
                        })
                        .then(res => {
                            this.historico = res.data;
                            this.modalAberto = true;
                        })
                        .catch(err => {
                            console.error("Erro ao carregar detalhes:", err);
                        });
                }
            },
            mounted() {
                this.carregarOperadoras();
            }
        });
    </script>
</body>

</html>