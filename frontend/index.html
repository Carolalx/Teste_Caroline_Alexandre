<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <title>Operadoras de Sa√∫de - Painel Administrativo</title>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.7.14/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            margin: 20px;
            background-color: #2c3e50;
            color: #ecf0f1;
        }

        .container {
            max-width: 1200px;
            margin: auto;
            background: #34495e;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #ecf0f1;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        .grafico-container {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            margin-bottom: 40px;
        }

        canvas {
            max-width: 450px;
        }

        .ranking-box {
            background: #34495e;
            border-radius: 8px;
            padding: 20px;
            width: 300px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .ranking-box h3 {
            margin-bottom: 15px;
            font-size: 1.2em;
            color: #ecf0f1;
        }

        .ranking-box ul {
            list-style: none;
            padding: 0;
            margin: 0;
            color: #ecf0f1;
        }

        .ranking-box li {
            font-size: 1em;
            margin-bottom: 10px;
        }

        .ranking-box li strong {
            font-weight: bold;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th,
        td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #555;
        }

        th {
            background-color: #3498db;
            color: white;
        }

        tr:hover {
            background-color: #3a4f66;
        }

        .pagination {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
        }

        button {
            padding: 8px 16px;
            cursor: pointer;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            transition: 0.3s;
        }

        button:hover {
            background: #2980b9;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .loading-overlay {
            color: #3498db;
            font-weight: bold;
            padding: 20px;
            text-align: center;
        }
    </style>
</head>

<body>
    <div id="app" class="container">
        <h1>üìä Gest√£o de Operadoras de Sa√∫de</h1>

        <!-- Gr√°ficos lado a lado -->
        <div class="grafico-container">
            <div>
                <h2 style="font-size: 1.1em;">Distribui√ß√£o das Operadoras</h2>
                <canvas id="graficoPizza" height="300"></canvas>
            </div>
            <div>
                <h2 style="font-size: 1.1em;">Despesas por UF</h2>
                <canvas id="graficoUF" height="300"></canvas>
            </div>
            <div class="ranking-box">
                <h3>Top 5 Crescimento</h3>
                <ul id="rankingList">
                    <!-- O Ranking ser√° preenchido dinamicamente -->
                </ul>
            </div>
        </div>

        <div class="search-box">
            <input type="text" v-model="busca" placeholder="Pesquisar por Raz√£o Social, CNPJ ou ANS..." />
            <span v-if="loading">‚è≥ Carregando...</span>
        </div>

        <div v-if="loading && operadoras.length === 0" class="loading-overlay">
            Buscando dados no servidor...
        </div>

        <table v-if="operadoras.length > 0">
            <thead>
                <tr>
                    <th>Registro ANS</th>
                    <th>CNPJ</th>
                    <th>Raz√£o Social</th>
                    <th>UF</th>
                    <th>Ano/Trimestre</th>
                    <th>Valor Despesa</th>
                    <th>A√ß√µes</th>
                </tr>
            </thead>
            <tbody>
                <tr v-for="op in operadoras" :key="op.RegistroANS + op.Ano + op.Trimestre">
                    <td><strong>{{ op.RegistroANS }}</strong></td>
                    <td>{{ op.CNPJ }}</td>
                    <td>{{ op.RazaoSocial }}</td>
                    <td>{{ op.UF }}</td>
                    <td>{{ op.Ano }}/{{ op.Trimestre }}¬∫</td>
                    <td>{{ formatCurrency(op.ValorDespesas) }}</td>
                    <td><button @click="abrirDetalhes(op.RegistroANS)">Detalhes</button></td>
                </tr>
            </tbody>
        </table>

        <div v-if="!loading && operadoras.length === 0" style="text-align: center; padding: 40px;">
            <p>Nenhum resultado encontrado para "{{ busca }}".</p>
        </div>

        <div class="pagination" v-if="totalPages > 1">
            <button @click="mudarPagina(paginaAtual - 1)" :disabled="paginaAtual === 1">Anterior</button>
            <span>P√°gina {{ paginaAtual }} de {{ totalPages }} (Total: {{ total }})</span>
            <button @click="mudarPagina(paginaAtual + 1)" :disabled="paginaAtual === totalPages">Pr√≥xima</button>
        </div>
    </div>

    <script>
        new Vue({
            el: "#app",
            data: {
                operadoras: [],
                busca: "",
                loading: false,
                paginaAtual: 1,
                limite: 15,
                total: 0,
                modalAberto: false,
                detalhes: null,
                historico: [],
                graficoPizza: null,
                graficoUF: null,
                ranking: [],
                debounceTimer: null
            },
            computed: {
                totalPages() {
                    return Math.ceil(this.total / this.limite);
                }
            },
            watch: {
                busca(novaBusca) {
                    clearTimeout(this.debounceTimer);
                    this.debounceTimer = setTimeout(() => {
                        this.paginaAtual = 1;
                        this.carregarOperadoras();
                    }, 500);
                }
            },
            methods: {
                carregarOperadoras() {
                    this.loading = true;
                    const url = `http://127.0.0.1:8000/api/operadoras?page=${this.paginaAtual}&limit=${this.limite}&q=${this.busca}`;

                    axios.get(url)
                        .then(res => {
                            this.operadoras = res.data.data;
                            this.total = res.data.total;
                            this.loading = false;
                            this.$nextTick(() => {
                                this.atualizarGraficoPizza();
                                this.atualizarGraficoUF();
                                this.atualizarRanking();
                            });
                        })
                        .catch(err => {
                            console.error("Erro na API:", err);
                            this.loading = false;
                        });
                },
                atualizarGraficoPizza() {
                    const ctx = document.getElementById('graficoPizza').getContext('2d');
                    const dadosOperadoras = {};

                    this.operadoras.forEach(op => {
                        dadosOperadoras[op.RazaoSocial] = (dadosOperadoras[op.RazaoSocial] || 0) + op.ValorDespesas;
                    });

                    const labels = Object.keys(dadosOperadoras);
                    const data = Object.values(dadosOperadoras);

                    if (this.graficoPizza) this.graficoPizza.destroy();

                    this.graficoPizza = new Chart(ctx, {
                        type: 'pie',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Despesas das Operadoras',
                                data: data,
                                backgroundColor: [
                                    '#FF5733', '#33FF57', '#3357FF', '#57FF33', '#FF33A6', '#A633FF', '#33FFF6', '#F6FF33'
                                ]
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    position: 'top',
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function (tooltipItem) {
                                            return tooltipItem.label + ": " + tooltipItem.raw.toFixed(2).replace('.', ',') + " R$";
                                        }
                                    }
                                }
                            }
                        }
                    });
                },
                atualizarGraficoUF() {
                    axios.get("http://127.0.0.1:8000/api/estatisticas/despesas_uf")
                        .then(res => {
                            const ctx = document.getElementById('graficoUF').getContext('2d');
                            const dadosUF = res.data;

                            const labels = dadosUF.map(item => item.uf);
                            const data = dadosUF.map(item => item.total_despesas_uf);

                            if (this.graficoUF) this.graficoUF.destroy();

                            this.graficoUF = new Chart(ctx, {
                                type: 'bar',
                                data: {
                                    labels: labels,
                                    datasets: [{
                                        label: 'Despesas por Estado (R$)',
                                        data: data,
                                        backgroundColor: '#3498db'
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    scales: {
                                        y: {
                                            beginAtZero: true
                                        }
                                    }
                                }
                            });
                        })
                        .catch(err => {
                            console.error("Erro ao carregar gr√°fico de Despesas por UF:", err);
                        });
                },
                atualizarRanking() {
                    axios.get("http://127.0.0.1:8000/api/estatisticas/crescimento")
                        .then(res => {
                            const rankingList = document.getElementById('rankingList');
                            rankingList.innerHTML = ""; // Limpa o conte√∫do existente

                            // Ordena os dados de acordo com o crescimento (do maior para o menor)
                            res.data.sort((a, b) => b.crescimento_percentual - a.crescimento_percentual);

                            res.data.forEach((item, index) => {
                                const operadora = item.razaosocial || 'Operadora desconhecida';
                                const crescimento = item.crescimento_percentual || 0;

                                const li = document.createElement('li');
                                li.innerHTML = `<strong>${index + 1}</strong>. ${operadora} - ${crescimento.toFixed(2)}`; // Crescimento sem o "%"
                                rankingList.appendChild(li);
                            });
                        })
                        .catch(err => {
                            console.error("Erro na API de crescimento:", err);
                        });
                },
                formatCurrency(valor) {
                    return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(valor);
                },
                mudarPagina(n) {
                    this.paginaAtual = n;
                    this.carregarOperadoras();
                    window.scrollTo(0, 0);
                }
            },
            mounted() {
                this.carregarOperadoras();
            }
        });
    </script>
</body>

</html>